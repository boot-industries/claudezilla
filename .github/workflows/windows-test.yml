name: Windows Test

on:
  push:
    branches: [feature/windows-support-v0.5.5]
  workflow_dispatch:

jobs:
  test-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test IPC module
        shell: bash
        run: |
          node -e "
          import('./host/ipc.js').then(ipc => {
            console.log('=== IPC Module Test (Windows) ===');
            console.log('Platform:', process.platform);
            console.log('isWindows:', ipc.isWindows());

            // Test path generation
            const socketPath = ipc.getSocketPath();
            const authPath = ipc.getAuthTokenPath();
            const debugPath = ipc.getDebugLogPath();

            console.log('Socket path:', socketPath);
            console.log('Auth token path:', authPath);
            console.log('Debug log path:', debugPath);

            // Verify Windows paths
            if (process.platform === 'win32') {
              if (!socketPath.startsWith('\\\\\\\\.\\\\pipe\\\\')) {
                throw new Error('Socket path should be named pipe on Windows');
              }
              if (!authPath.includes('claudezilla')) {
                throw new Error('Auth path should contain claudezilla');
              }
            }

            // Test path validation
            console.log('');
            console.log('=== Path Validation Tests ===');

            // Valid path
            try {
              ipc.validatePath('C:\\\\Users\\\\test', 'valid');
              console.log('Valid path: PASS');
            } catch (e) {
              console.log('Valid path: FAIL', e.message);
              process.exit(1);
            }

            // Path traversal
            try {
              ipc.validatePath('C:\\\\..\\\\Windows', 'traversal');
              console.log('Traversal: FAIL (should reject)');
              process.exit(1);
            } catch (e) {
              console.log('Traversal: PASS (rejected)');
            }

            // Null byte
            try {
              ipc.validatePath('C:\\\\test\\x00evil', 'null');
              console.log('Null byte: FAIL (should reject)');
              process.exit(1);
            } catch (e) {
              console.log('Null byte: PASS (rejected)');
            }

            // UNC path (should reject non-pipe UNC)
            try {
              ipc.validatePath('\\\\\\\\server\\\\share', 'unc');
              console.log('UNC path: FAIL (should reject)');
              process.exit(1);
            } catch (e) {
              console.log('UNC path: PASS (rejected)');
            }

            // Named pipe (should allow)
            try {
              ipc.validatePath('\\\\\\\\.\\\\pipe\\\\test', 'pipe');
              console.log('Named pipe: PASS (allowed)');
            } catch (e) {
              console.log('Named pipe: FAIL (should allow)', e.message);
              process.exit(1);
            }

            console.log('');
            console.log('=== All Tests Passed ===');
          }).catch(e => {
            console.error('Module error:', e);
            process.exit(1);
          });
          "

      - name: Test PowerShell installer syntax
        shell: pwsh
        run: |
          Write-Host "=== PowerShell Syntax Check ==="

          # Parse installer without executing
          $installerPath = "install/install-windows.ps1"
          $uninstallerPath = "install/uninstall-windows.ps1"

          try {
            $null = [System.Management.Automation.Language.Parser]::ParseFile(
              $installerPath,
              [ref]$null,
              [ref]$errors
            )
            if ($errors.Count -gt 0) {
              Write-Host "Installer syntax errors:"
              $errors | ForEach-Object { Write-Host $_ }
              exit 1
            }
            Write-Host "Installer syntax: PASS"
          } catch {
            Write-Host "Installer parse error: $_"
            exit 1
          }

          try {
            $null = [System.Management.Automation.Language.Parser]::ParseFile(
              $uninstallerPath,
              [ref]$null,
              [ref]$errors
            )
            if ($errors.Count -gt 0) {
              Write-Host "Uninstaller syntax errors:"
              $errors | ForEach-Object { Write-Host $_ }
              exit 1
            }
            Write-Host "Uninstaller syntax: PASS"
          } catch {
            Write-Host "Uninstaller parse error: $_"
            exit 1
          }

          Write-Host ""
          Write-Host "=== Test-SafePath Function ==="

          # Source the installer to get the function
          . ./install/install-windows.ps1 -ErrorAction SilentlyContinue 2>$null

          # The sourcing will fail (no Node), but we can define the function manually
          function Test-SafePath {
              param([string]$Path, [string]$Context)
              if ([string]::IsNullOrWhiteSpace($Path)) { throw "$Context is empty" }
              if ($Path -match '\.\.') { throw "$Context contains path traversal" }
              if ($Path -match '^\\\\' -and $Path -notmatch '^\\\\\.\\pipe\\') { throw "$Context is UNC" }
              if ($Path -match '[<>"|?*]') { throw "$Context contains invalid chars" }
              return $true
          }

          # Test valid path
          try {
            Test-SafePath -Path "C:\Users\test" -Context "valid"
            Write-Host "Valid path: PASS"
          } catch {
            Write-Host "Valid path: FAIL $_"
            exit 1
          }

          # Test traversal
          try {
            Test-SafePath -Path "C:\..\Windows" -Context "traversal"
            Write-Host "Traversal: FAIL (should reject)"
            exit 1
          } catch {
            Write-Host "Traversal: PASS (rejected)"
          }

          # Test UNC
          try {
            Test-SafePath -Path "\\server\share" -Context "unc"
            Write-Host "UNC: FAIL (should reject)"
            exit 1
          } catch {
            Write-Host "UNC: PASS (rejected)"
          }

          Write-Host ""
          Write-Host "=== All PowerShell Tests Passed ==="

      - name: Test MCP server import
        shell: bash
        run: |
          cd mcp && npm install --silent
          node -e "
          import('../mcp/server.js').then(() => {
            console.log('MCP server loads on Windows: PASS');
            process.exit(0);
          }).catch(e => {
            console.error('MCP server error:', e.message);
            process.exit(1);
          });
          " 2>&1 | head -10
