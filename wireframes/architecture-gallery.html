<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claudezilla - Architecture Gallery</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-card: #2a2a2a;
            --accent: #FF6B00;
            --accent-secondary: #FF9500;
            --border: #333;
        }

        /* Input Sans */
        @font-face {
            font-family: 'InputSans-Regular';
            src: url('../../shared-fonts/input/InputSans/InputSans/InputSans-Regular.ttf') format('truetype');
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'InputSans-Medium';
            src: url('../../shared-fonts/input/InputSans/InputSans/InputSans-Medium.ttf') format('truetype');
            font-weight: 500;
            font-display: swap;
        }
        @font-face {
            font-family: 'InputSans-Bold';
            src: url('../../shared-fonts/input/InputSans/InputSans/InputSans-Bold.ttf') format('truetype');
            font-weight: 700;
            font-display: swap;
        }
        @font-face {
            font-family: 'InputSans-Light';
            src: url('../../shared-fonts/input/InputSans/InputSans/InputSans-Light.ttf') format('truetype');
            font-weight: 300;
            font-display: swap;
        }
        /* Input Mono */
        @font-face {
            font-family: 'InputMono-Regular';
            src: url('../../shared-fonts/input/InputMono/InputMono/InputMono-Regular.ttf') format('truetype');
            font-weight: 400;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'InputSans-Regular', 'Input Sans', system-ui, sans-serif;
            background: var(--bg-primary);
            color: #e0e0e0;
            padding: 0.75rem 1.5rem;
            line-height: 1.5;
            font-size: 0.875rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 0.5rem;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline;
        }

        header .version-badge {
            display: inline-block;
            background: var(--accent);
            color: #000;
            font-size: 0.55rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-weight: 700;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .subtitle {
            color: #888;
            margin-bottom: 0.35rem;
            font-size: 0.7rem;
        }

        .last-updated {
            color: #666;
            font-size: 0.6rem;
            margin-bottom: 0.5rem;
        }

        .info {
            background: #2a2a1a;
            border-left: 3px solid var(--accent-secondary);
            padding: 0.5rem 0.65rem;
            margin-bottom: 0.6rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .info-title {
            color: var(--accent-secondary);
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .new-badge {
            background: var(--accent-secondary);
            color: #000;
            font-size: 0.5rem;
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            font-weight: 600;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .nav-legend-row {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .quick-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            align-items: center;
        }

        .quick-nav a {
            background: var(--bg-card);
            color: var(--accent-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            text-decoration: none;
            font-size: 0.65rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .quick-nav a:hover {
            background: #3a3a3a;
        }

        .quick-nav .section-label {
            background: transparent;
            color: #666;
            padding-left: 0;
            cursor: default;
            font-size: 0.65rem;
        }

        .legend {
            background: var(--bg-secondary);
            border-radius: 5px;
            padding: 0.4rem 0.6rem;
        }

        .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.6rem;
        }

        .legend-item .swatch {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .diagram-grid {
            display: grid;
            gap: 1rem;
        }

        .diagram-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .diagram-card.selected {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
        }

        .diagram-header {
            background: var(--bg-card);
            padding: 0.75rem 1rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .diagram-header:hover {
            background: #333;
        }

        .diagram-toggle {
            font-size: 0.6rem;
            color: #888;
            transition: transform 0.2s;
            flex-shrink: 0;
            line-height: 1;
        }

        .diagram-card.collapsed .diagram-toggle {
            transform: rotate(-90deg);
        }

        .diagram-header h2 {
            font-weight: 600;
            color: #fff;
            font-size: 0.875rem;
            flex-shrink: 0;
            white-space: nowrap;
            margin: 0;
            padding: 0;
            border: none;
        }

        .diagram-badge {
            font-size: 0.625rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .diagram-badge.flowchart { background: #3a2a1a; color: var(--accent-secondary); }
        .diagram-badge.sequence { background: #2a3a4a; color: #4CAF50; }
        .diagram-badge.class { background: #3a3a2a; color: #FFB74D; }
        .diagram-badge.er { background: #3a2a3a; color: #CE93D8; }

        .diagram-description {
            font-size: 0.7rem;
            color: #888;
            margin-left: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex: 1 1 0;
        }

        .diagram-content {
            padding: 1rem;
            overflow-x: auto;
            background: #1e1e1e;
            max-height: 5000px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .diagram-card.collapsed .diagram-content {
            max-height: 0;
            padding: 0 1rem;
            opacity: 0;
            overflow: hidden;
        }

        .diagram-content pre {
            background: transparent;
            margin: 0;
        }

        .mermaid {
            display: flex;
            justify-content: center;
            overflow-x: auto;
        }

        .mermaid svg {
            min-width: 900px;
            max-width: 100%;
            height: auto;
        }

        /* Edge label styling */
        .mermaid .edgeLabel foreignObject {
            overflow: visible;
        }
        .mermaid .edgeLabel div {
            padding: 4px 10px;
            background: #3a2a1a !important;
            border-radius: 3px;
        }
        .mermaid .edgeLabel rect,
        .mermaid .labelBkg {
            fill: #3a2a1a !important;
            rx: 3px;
            ry: 3px;
        }

        /* Line and border thickness */
        .mermaid .flowchart-link,
        .mermaid .edgePath path,
        .mermaid .transition path {
            stroke-width: 2px !important;
        }
        .mermaid .node rect,
        .mermaid .node circle,
        .mermaid .node polygon,
        .mermaid .cluster rect,
        .mermaid .statediagram-state rect {
            stroke-width: 2px !important;
        }

        /* Node text - prevent clipping */
        .mermaid .cluster-label {
            white-space: nowrap;
            padding: 8px 12px;
        }
        .mermaid .cluster-label .nodeLabel {
            white-space: nowrap;
            padding: 4px 8px;
        }
        .mermaid .nodeLabel {
            white-space: nowrap;
        }
        .mermaid .label foreignObject {
            overflow: visible;
        }
        .mermaid .cluster rect {
            rx: 8px;
            ry: 8px;
        }
        .mermaid .cluster .label {
            margin-bottom: 12px;
        }
        .mermaid .cluster foreignObject {
            overflow: visible;
        }

        footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            color: #666;
            font-size: 0.625rem;
        }

        footer a {
            color: var(--accent-secondary);
        }

        kbd {
            background: #333;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            border: 1px solid #444;
            font-family: 'InputMono-Regular', monospace;
        }

        .keyboard-hints {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.6rem;
            color: #888;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 100;
            opacity: 0.8;
        }

        .keyboard-hints:hover {
            opacity: 1;
        }

        .keyboard-hints div {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        @media (max-width: 900px) {
            body {
                padding: 0.5rem 1rem;
            }
            .nav-legend-row {
                flex-direction: column;
            }
            .mermaid svg {
                min-width: 600px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 0.5rem 0.75rem;
            }
            header h1 {
                font-size: 1.1rem;
            }
            .diagram-content {
                padding: 0.5rem;
            }
            .mermaid svg {
                min-width: 100%;
            }
            .keyboard-hints {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Claudezilla - Architecture Gallery</h1>
            <span class="version-badge">v0.5.6</span>
            <p class="subtitle">Firefox Browser Automation for Claude Code CLI - A Google-free Alternative</p>
            <p class="last-updated">Last updated: 2026-02-01 | Version: 0.5.6</p>
        </header>

        <div class="info">
            <div class="info-title">Interactive Diagram Collection <span class="new-badge">v0.5.6</span></div>
            7 architectural diagrams covering system architecture, component relationships, data flow, repository structure, entry points, database schema, and deployment infrastructure.
            <strong>New in v0.5.6:</strong> Autonomous installation (auto-configure Claude Code permissions), extended timeouts (150s), mutex timeout fix (3s).
            Click headers to expand/collapse. Diagrams render via Mermaid.js. <kbd>&uarr;</kbd><kbd>&darr;</kbd> navigate, <kbd>&rarr;</kbd> expand, <kbd>&larr;</kbd> collapse. <kbd>a</kbd> expand all, <kbd>Esc</kbd> collapse all.
        </div>

        <div class="nav-legend-row">
            <nav class="quick-nav">
                <span class="section-label">System:</span>
                <a href="#architecture">Architecture</a>
                <a href="#components">Components</a>
                <a href="#dataflow">Data Flow</a>
                <span class="section-label">Structure:</span>
                <a href="#repo">Repository</a>
                <a href="#entry">Entry Points</a>
                <a href="#database">Database</a>
                <a href="#deployment">Deployment</a>
            </nav>
            <div class="legend">
                <div class="legend-grid">
                    <div class="legend-item">
                        <span class="swatch" style="background: #bbdefb;"></span>
                        <span>MCP Layer</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #c8e6c9;"></span>
                        <span>Extension</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #fff9c4;"></span>
                        <span>Native Host</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #f8bbd0;"></span>
                        <span>Security</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #e1bee7;"></span>
                        <span>Plugin</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #ffe0b2;"></span>
                        <span>Cloud Services</span>
                    </div>
                    <div class="legend-item">
                        <span class="swatch" style="background: #ffd; border: 1px solid #f90;"></span>
                        <span>New in v0.5.6</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagram-grid">
            <!-- Architecture Overview -->
            <div class="diagram-card" id="architecture">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>System Architecture</h2>
                    <span class="diagram-badge flowchart">FLOWCHART</span>
                    <span class="diagram-description">4-layer architecture with IPC abstraction for cross-platform support</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
flowchart TB
    subgraph CLAUDE["Claude Code CLI"]
        SDK["Anthropic SDK"]
        MCP_CLIENT["MCP Client"]
    end

    subgraph MCP_LAYER["MCP Server Layer"]
        MCP_SERVER["MCP Server<br/>(mcp/server.js)"]
        TOOLS["27 Browser Tools"]
        HEARTBEAT["Agent Heartbeat<br/>Tracking"]
        ORPHAN["Orphan Cleanup<br/>(2min timeout)"]
        EXPR_BLOCK["Expression Blocklist<br/>(fetch, eval, cookies)"]
    end

    subgraph HOST_LAYER["Native Host Layer"]
        IPC_LAYER["IPC Abstraction<br/>(host/ipc.js)"]
        subgraph IPC_UNIX["Unix (macOS/Linux)"]
            SOCKET["Unix Socket<br/>(claudezilla.sock)"]
        end
        subgraph IPC_WIN["Windows 10/11"]
            NAMED_PIPE["Named Pipe<br/>(\\.\pipe\claudezilla)"]
        end
        AUTH["Auth Token<br/>(32-byte random)"]
        PATH_VALID["Path Validation<br/>(validatePath)"]
        LOOP_STATE["Loop State<br/>Manager"]
        PROTO["Protocol Handler<br/>(4-byte header)"]
    end

    subgraph EXTENSION_LAYER["Firefox Extension Layer"]
        BG["Background Script<br/>(Persistent)"]
        SESSION["Session Manager<br/>(12-tab pool)"]
        MUTEX["Screenshot Mutex<br/>(3s timeout)"]
        NETWORK["Network Monitor<br/>(webRequest API)"]
    end

    subgraph CONTENT_LAYER["Content Scripts"]
        DOM["DOM Manipulation"]
        VISUALS["Claudezilla Visuals<br/>(Watermark, Glow)"]
        CONSOLE["Console Capture"]
        A11Y["Accessibility Tree"]
    end

    subgraph BROWSER["Firefox Browser"]
        PRIVATE["Private Window"]
        TABS["Tab Pool<br/>(Max 12)"]
        PAGES["Web Pages"]
    end

    subgraph PLUGIN_LAYER["Claude Plugin"]
        STOP_HOOK["Stop Hook<br/>(focus-loop.sh)"]
        COMMANDS["Slash Commands<br/>(/focus, /cancel-focus)"]
    end

    CLAUDE -->|MCP Protocol| MCP_SERVER
    MCP_SERVER -->|Agent ID| HEARTBEAT
    MCP_SERVER -->|Validate| EXPR_BLOCK
    HEARTBEAT -->|Timeout| ORPHAN
    MCP_SERVER -->|Commands + Auth| IPC_LAYER
    IPC_LAYER -->|macOS/Linux| SOCKET
    IPC_LAYER -->|Windows| NAMED_PIPE
    SOCKET -->|Native Messaging| BG
    NAMED_PIPE -->|Native Messaging| BG
    BG -->|executeInTab| DOM
    BG -->|browser.tabs| TABS
    TABS --> PAGES
    DOM --> PAGES
    VISUALS --> PAGES

    STOP_HOOK -.->|Query State| IPC_LAYER
    COMMANDS -.->|Start/Stop| MCP_SERVER

    AUTH -->|Validates| IPC_LAYER
    PATH_VALID -->|Secure paths| IPC_LAYER
    MUTEX -.->|Serializes| BG
    SESSION -.->|Ownership| TABS
                    </pre>
                </div>
            </div>

            <!-- Component Map -->
            <div class="diagram-card" id="components">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Component Map</h2>
                    <span class="diagram-badge class">CLASS</span>
                    <span class="diagram-description">Modules with APIs, IPC abstraction, and tool categories</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
classDiagram
    class MCPServer {
        +Server server
        +String AGENT_ID
        +Map agentHeartbeats
        +Array EXPRESSION_BLOCKLIST
        +sendCommand(command, params)
        +runDiagnostics()
        +cleanupOrphanedAgents()
        +updateAgentHeartbeat(agentId)
        +truncateAgentId(agentId)
        +handleShutdown(signal)
        +validateExpression(expression)
    }

    class IPC {
        &lt;&lt;module&gt;&gt;
        +getSocketPath() String
        +getAuthTokenPath() String
        +getSafeTempDir() String
        +validatePath(path, context)
        +cleanupSocket(socketPath)
        +setSecurePermissions(path, mode)
        +setWindowsFileACL(path)
        +isWindows() Boolean
    }

    class NativeHost {
        +Object loopState
        +Server socketServer
        +String SOCKET_AUTH_TOKEN
        +Map pendingCliRequests
        +handleLoopCommand(command, params)
        +handleCliCommand(command, params, auth)
        +handleExtensionMessage(message)
        +startSocketServer()
    }

    class BackgroundScript {
        +Port port
        +Map pendingRequests
        +Object claudezillaWindow
        +Number activeTabId
        +Promise screenshotLock
        +Array pendingSlotRequests
        +Map slotReservations
        +connect()
        +sendToHost(command, params)
        +handleCliCommand(message)
        +verifyTabOwnership(tabId, agentId)
        +waitForPageReady(tabId, options)
        +handleGoodbye(agentId)
        +createSlotReservation(agentId)
    }

    class ContentScript {
        +click(params) Object
        +type(params) Object
        +getContent(params) Object
        +getPageState() Object
        +getAccessibilitySnapshot() Object
        +evaluate(expression) Object
        +enableClaudezillaVisuals()
    }

    class BrowserTools {
        firefox_create_window()
        firefox_navigate()
        firefox_close_tab()
        firefox_close_window()
        firefox_get_tabs()
        firefox_resize_window()
        firefox_set_viewport()
    }

    class PageTools {
        firefox_get_content()
        firefox_click()
        firefox_type()
        firefox_press_key()
        firefox_scroll()
        firefox_wait_for()
    }

    class AnalysisTools {
        firefox_screenshot()
        firefox_get_page_state()
        firefox_get_accessibility_snapshot()
        firefox_get_element()
        firefox_evaluate()
    }

    class DevTools {
        firefox_get_console()
        firefox_get_network()
    }

    class CoordinationTools {
        firefox_request_tab_space()
        firefox_grant_tab_space()
        firefox_get_slot_requests()
    }

    class DiagnosticTools {
        firefox_diagnose()
    }

    class LoopTools {
        firefox_start_loop()
        firefox_stop_loop()
        firefox_loop_status()
    }

    MCPServer --> IPC : platform paths
    MCPServer --> NativeHost : Unix socket/Named pipe
    IPC --> NativeHost : socket/pipe paths
    NativeHost --> BackgroundScript : native messaging
    BackgroundScript --> ContentScript : executeInTab

    MCPServer ..> BrowserTools
    MCPServer ..> PageTools
    MCPServer ..> AnalysisTools
    MCPServer ..> DevTools
    MCPServer ..> CoordinationTools
    MCPServer ..> DiagnosticTools
    MCPServer ..> LoopTools
                    </pre>
                </div>
            </div>

            <!-- Data Flow -->
            <div class="diagram-card" id="dataflow">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Data Flow</h2>
                    <span class="diagram-badge sequence">SEQUENCE</span>
                    <span class="diagram-description">Command flow, screenshot mutex, expression validation, session cleanup, slot reservation</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
sequenceDiagram
    participant Claude as Claude Code CLI
    participant MCP as MCP Server
    participant IPC as IPC Layer
    participant Host as Native Host
    participant BG as Background Script
    participant CS as Content Script
    participant Page as Web Page

    Note over Claude,Page: Standard Command Flow (e.g., firefox_click)

    Claude->>+MCP: CallToolRequest {name: "firefox_click", args}
    MCP->>MCP: Inject agentId, updateHeartbeat()
    MCP->>+IPC: getSocketPath()
    IPC-->>-MCP: Unix socket or Named pipe path
    MCP->>+Host: JSON + auth {command, params, authToken}
    Host->>Host: Validate authToken
    Host->>+BG: Native Messaging: {id, type, command, params}
    BG->>BG: verifyTabOwnership(tabId, agentId)
    BG->>+CS: browser.tabs.sendMessage({action: "click"})
    CS->>+Page: element.click()
    Page-->>-CS: Event dispatched
    CS-->>-BG: {success: true, result}
    BG-->>-Host: port.postMessage response
    Host-->>-MCP: JSON response
    MCP-->>-Claude: {content: [{type: "text", text: result}]}

    Note over Claude,Page: Screenshot with Mutex (3s timeout)

    Claude->>+MCP: firefox_screenshot({tabId})
    MCP->>+BG: screenshot command
    BG->>BG: Check screenshotMutexHolder
    alt Mutex held by another agent >3s
        BG-->>MCP: MUTEX_BUSY error
    else Mutex available
        BG->>BG: Acquire mutex
        BG->>BG: Switch to target tab
        BG->>+CS: waitForPageReady()
        CS-->>-BG: {timeline, waitMs}
        BG->>BG: captureVisibleTab()
        BG->>+CS: resizeImage(dataUrl, scale)
        CS-->>-BG: Compressed JPEG
        BG->>BG: Release mutex
        BG-->>-MCP: {dataUrl, readiness}
        MCP-->>-Claude: {type: "image", data: base64}
    end

    Note over Claude,Page: Expression Validation (v0.5.6)

    Claude->>+MCP: firefox_evaluate({expression: "fetch(...)"})
    MCP->>MCP: validateExpression(expression)
    alt Expression blocked
        MCP-->>Claude: Error: Blocked pattern 'fetch('
    else Expression allowed
        MCP->>+Host: {command: "evaluate", params}
        Host->>+CS: evaluate(expression)
        CS-->>-Host: Result
        Host-->>-MCP: Response
        MCP-->>-Claude: Result
    end

    Note over Claude,Page: Session Cleanup (v0.5.6)

    Claude->>MCP: Session ending (SIGINT/SIGTERM)
    MCP->>MCP: handleShutdown(signal)
    MCP->>+Host: {command: "goodbye", agentId}
    Host->>+BG: goodbye message
    BG->>BG: Close all tabs owned by agentId
    BG->>BG: Remove slot reservations
    BG->>BG: Remove pending requests
    BG-->>-Host: {closed: N, cleaned: true}
    Host-->>-MCP: Cleanup confirmed

    Note over Claude,Page: Slot Reservation Flow (v0.5.6)

    Claude->>+MCP: firefox_create_window({url})
    MCP->>+BG: createWindow command
    BG-->>-MCP: POOL_FULL error (12/12 tabs)
    MCP-->>-Claude: Error: POOL_FULL

    Claude->>+MCP: firefox_request_tab_space()
    MCP->>+BG: requestTabSpace
    BG->>BG: Queue slot request for agentId
    BG-->>-MCP: {queued: true}
    MCP-->>-Claude: Request queued

    Note right of BG: Another agent closes tab or grants space
    BG->>BG: createSlotReservation(agentId, 30s TTL)

    Claude->>+MCP: firefox_get_slot_requests()
    MCP->>+BG: getSlotRequests
    BG-->>-MCP: {youHaveReservation: true, reservationExpiresInMs: 28000}
    MCP-->>-Claude: Reservation ready

    Claude->>+MCP: firefox_create_window({url})
    MCP->>+BG: createWindow command
    BG->>BG: Check reservation for agentId
    BG->>BG: Valid reservation found, bypass POOL_FULL
    BG-->>-MCP: {tabId: 456, url}
    MCP-->>-Claude: Tab created
                    </pre>
                </div>
            </div>

            <!-- Repository Structure -->
            <div class="diagram-card" id="repo">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Repository Structure</h2>
                    <span class="diagram-badge flowchart">FLOWCHART</span>
                    <span class="diagram-description">Extension + Host + IPC + MCP + Plugin + Website + Worker</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
graph TB
    subgraph ROOT["claudezilla/"]
        CLAUDE["CLAUDE.md<br/>(Project docs)"]
        CHANGELOG["CHANGELOG.md"]
        README["README.md"]
        SECURITY["SECURITY.md"]
    end

    subgraph EXTENSION["extension/<br/>Firefox WebExtension"]
        MANIFEST["manifest.json<br/>(MV2)"]
        BG["background.js<br/>(Native messaging)"]
        CONTENT["content.js<br/>(DOM interaction)"]
        POPUP["popup/<br/>(Status UI)"]
    end

    subgraph HOST["host/<br/>Native Messaging Host"]
        HOST_INDEX["index.js<br/>(Main entry)"]
        HOST_IPC["ipc.js<br/>(IPC abstraction)"]
        HOST_PROTO["protocol.js<br/>(4-byte header)"]
    end

    subgraph MCP["mcp/<br/>MCP Server"]
        MCP_SERVER["server.js<br/>(27 tools)"]
        MCP_TASK["task-detector.js"]
    end

    subgraph PLUGIN["plugin/<br/>Claude Code Plugin"]
        HOOKS["hooks/<br/>(stop-hook.sh)"]
        COMMANDS["commands/<br/>(/focus, /help)"]
    end

    subgraph INSTALL["install/<br/>Setup Scripts"]
        MAC["install-macos.sh"]
        LINUX["install-linux.sh"]
        WIN["install-windows.ps1"]
    end

    subgraph WEBSITE["website/<br/>Marketing Site"]
        WEB_INDEX["index.html"]
        WEB_DOCS["docs.html"]
        WEB_SUPPORT["support.html"]
    end

    subgraph WORKER["worker/<br/>Cloudflare Worker"]
        WORKER_TS["src/index.ts<br/>(Stripe API)"]
    end

    ROOT --> EXTENSION
    ROOT --> HOST
    ROOT --> MCP
    ROOT --> PLUGIN
    ROOT --> INSTALL
    ROOT --> WEBSITE
    ROOT --> WORKER

    BG -.->|native messaging| HOST_INDEX
    HOST_INDEX -.->|imports| HOST_IPC
    HOST_INDEX -.->|IPC| MCP_SERVER
    PLUGIN -.->|stop hook| HOST_INDEX
                    </pre>
                </div>
            </div>

            <!-- Entry Points -->
            <div class="diagram-card" id="entry">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Entry Points</h2>
                    <span class="diagram-badge flowchart">FLOWCHART</span>
                    <span class="diagram-description">MCP tools, slash commands, popup, APIs, Windows installer</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
flowchart TB
    subgraph CLAUDE_CODE["Claude Code CLI"]
        MCP_TOOLS["MCP Tools<br/>(27 firefox_* tools)"]
        SLASH_CMDS["Slash Commands<br/>(/focus, /cancel-focus)"]
    end

    subgraph PLUGIN["Claude Plugin"]
        STOP_HOOK["Stop Hook<br/>(hooks/stop-hook.sh)"]
        CMD_FOCUS["focus.md"]
        CMD_CANCEL["cancel-focus.md"]
    end

    subgraph EXTENSION["Firefox Extension"]
        POPUP["Extension Popup<br/>(Click toolbar icon)"]
        BG_CONNECT["Background Script<br/>(Auto-connects)"]
    end

    subgraph HOST["Native Host"]
        subgraph IPC_UNIX["Unix"]
            SOCKET_SERVER["Unix Socket"]
        end
        subgraph IPC_WIN["Windows"]
            PIPE_SERVER["Named Pipe"]
        end
        NATIVE_MSG["Native Messaging<br/>(stdin/stdout)"]
    end

    subgraph CLOUD_API["Cloud APIs"]
        CHECKOUT["POST /create-checkout<br/>(Stripe session)"]
        NOTIFY["POST /notify<br/>(Email signup)"]
        HEALTH["GET /health"]
    end

    subgraph CLI_TOOLS["CLI Tools"]
        WEB_EXT["web-ext run<br/>(Development)"]
        INSTALL_MAC["install-macos.sh"]
        INSTALL_WIN["install-windows.ps1"]
    end

    MCP_TOOLS -->|Commands| SOCKET_SERVER
    MCP_TOOLS -->|Commands| PIPE_SERVER
    SLASH_CMDS --> CMD_FOCUS
    STOP_HOOK -->|Query loop state| SOCKET_SERVER
    STOP_HOOK -->|Query loop state| PIPE_SERVER
    POPUP -->|Test connection| BG_CONNECT
    BG_CONNECT <-->|Native Messaging| NATIVE_MSG
    SOCKET_SERVER <--> NATIVE_MSG
    PIPE_SERVER <--> NATIVE_MSG
                    </pre>
                </div>
            </div>

            <!-- Database Schema -->
            <div class="diagram-card" id="database">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Database Schema</h2>
                    <span class="diagram-badge er">ER DIAGRAM</span>
                    <span class="diagram-description">D1 database + in-memory state structures</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
erDiagram
    EMAIL_SIGNUPS {
        INTEGER id PK
        TEXT email UK
        INTEGER created_at
    }

    LOOP_STATE {
        BOOLEAN active
        TEXT prompt
        INTEGER iteration
        INTEGER maxIterations
        TEXT completionPromise
        TEXT startedAt
    }

    CLAUDEZILLA_WINDOW {
        INTEGER windowId
        INTEGER createdAt
        INTEGER groupId
    }

    TAB_ENTRY {
        INTEGER tabId PK
        TEXT ownerId
    }

    AGENT_HEARTBEAT {
        TEXT agentId PK
        INTEGER lastSeen
    }

    SCREENSHOT_MUTEX {
        TEXT agentId
        INTEGER acquiredAt
        TEXT requestId
    }

    NETWORK_REQUEST {
        TEXT requestId PK
        TEXT url
        TEXT method
        TEXT type
        INTEGER tabId
        TEXT status
        INTEGER statusCode
    }

    CLAUDEZILLA_WINDOW ||--o{ TAB_ENTRY : "contains max 12"
    TAB_ENTRY }o--|| AGENT_HEARTBEAT : "owned by"
                    </pre>
                </div>
            </div>

            <!-- Deployment Infrastructure -->
            <div class="diagram-card" id="deployment">
                <div class="diagram-header" onclick="toggleDiagram(this)">
                    <div class="diagram-toggle">&#9660;</div>
                    <h2>Deployment Infrastructure</h2>
                    <span class="diagram-badge flowchart">FLOWCHART</span>
                    <span class="diagram-description">Unix + Windows machines, Cloudflare Edge, External services</span>
                </div>
                <div class="diagram-content">
                    <pre class="mermaid">
flowchart TB
    subgraph USER_UNIX["User Machine (macOS/Linux)"]
        subgraph FIREFOX_UNIX["Firefox Browser"]
            EXT_UNIX["Claudezilla Extension"]
            PRIVATE_UNIX["Private Window"]
        end
        subgraph NATIVE_UNIX["Native Components"]
            HOST_UNIX["Native Host"]
            SOCKET_UNIX["Unix Socket<br/>($TMPDIR/claudezilla.sock)"]
        end
        subgraph CLAUDE_UNIX["Claude Code CLI"]
            MCP_UNIX["MCP Server"]
        end
    end

    subgraph USER_WIN["User Machine (Windows)"]
        subgraph FIREFOX_WIN["Firefox Browser"]
            EXT_WIN["Claudezilla Extension"]
            PRIVATE_WIN["Private Window"]
        end
        subgraph NATIVE_WIN["Native Components"]
            HOST_WIN["Native Host"]
            PIPE_WIN["Named Pipe<br/>(\\\\.\\pipe\\claudezilla)"]
        end
        subgraph CLAUDE_WIN["Claude Code CLI"]
            MCP_WIN["MCP Server"]
        end
    end

    subgraph CLOUDFLARE["Cloudflare Edge"]
        PAGES["Cloudflare Pages<br/>(claudezilla.com)"]
        WORKER["Cloudflare Worker<br/>(Stripe API)"]
        D1["D1 Database<br/>(email_signups)"]
    end

    subgraph EXTERNAL["External Services"]
        STRIPE["Stripe API"]
        AMO["Firefox Add-ons"]
        GITHUB["GitHub"]
    end

    EXT_UNIX <-->|Native Messaging| HOST_UNIX
    HOST_UNIX <-->|Unix Socket| SOCKET_UNIX
    SOCKET_UNIX <-->|Commands| MCP_UNIX

    EXT_WIN <-->|Native Messaging| HOST_WIN
    HOST_WIN <-->|Named Pipe| PIPE_WIN
    PIPE_WIN <-->|Commands| MCP_WIN

    PAGES -.->|Serves| WEBSITE[/"Website"/]
    WORKER -.->|Payment| STRIPE
    WORKER -.->|Store| D1

    AMO -.->|Install| EXT_UNIX
    AMO -.->|Install| EXT_WIN
    GITHUB -.->|Deploy| PAGES
                    </pre>
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Source:</strong> <code>wireframes/v0.5.6/*.mermaid.md</code></p>
            <p>Generated for: <strong>Claudezilla</strong> | Location: <code>~/dev/claudezilla</code></p>
            <p>Stack: Node.js (MCP, Host), JavaScript (Extension), TypeScript (Worker)</p>
            <p>Links: <a href="https://claudezilla.com">Website</a> | <a href="https://github.com/boot-industries/claudezilla">GitHub</a> | <a href="https://addons.mozilla.org/firefox/addon/claudezilla/">Firefox Add-ons</a></p>
        </footer>
    </div>

    <div class="keyboard-hints">
        <div><kbd>&uarr;</kbd><kbd>&darr;</kbd> Navigate</div>
        <div><kbd>&larr;</kbd> Collapse</div>
        <div><kbd>&rarr;</kbd> Expand</div>
        <div><kbd>Esc</kbd> Collapse all</div>
        <div><kbd>A</kbd> Expand all</div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                fontFamily: '"InputMono-Regular", "SF Mono", "Fira Code", monospace',
                darkMode: true,
                background: '#1a1a1a',
                primaryColor: '#2a2a2a',
                primaryTextColor: '#e0e0e0',
                primaryBorderColor: '#FF9500',
                lineColor: '#FF6B00',
                secondaryColor: '#1a1a1a',
                tertiaryColor: '#9C27B0',
                edgeLabelBackground: '#3a2a1a'
            },
            flowchart: { curve: 'basis' },
            sequence: { mirrorActors: false }
        });

        let selectedIndex = -1;

        function getCards() {
            return Array.from(document.querySelectorAll('.diagram-card'));
        }

        function selectCard(index) {
            const cards = getCards();
            if (cards.length === 0) return;

            // Remove previous selection
            cards.forEach(c => c.classList.remove('selected'));

            // Clamp index
            if (index < 0) index = 0;
            if (index >= cards.length) index = cards.length - 1;
            selectedIndex = index;

            // Apply selection
            cards[selectedIndex].classList.add('selected');
            cards[selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function toggleDiagram(header) {
            const card = header.closest('.diagram-card');
            card.classList.toggle('collapsed');
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA') return;

            const cards = getCards();

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectCard(selectedIndex + 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectCard(selectedIndex - 1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectedIndex < cards.length) {
                        cards[selectedIndex].classList.remove('collapsed');
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectedIndex < cards.length) {
                        cards[selectedIndex].classList.add('collapsed');
                    }
                    break;
                case 'Escape':
                    cards.forEach(c => c.classList.add('collapsed'));
                    break;
                case 'a':
                    if (!e.ctrlKey && !e.metaKey) {
                        cards.forEach(c => c.classList.remove('collapsed'));
                    }
                    break;
            }
        });

        // Quick-nav smooth scroll with card selection
        document.querySelectorAll('.quick-nav a[href^="#"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').slice(1);
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const cards = getCards();
                    const index = cards.indexOf(target);
                    if (index !== -1) {
                        selectCard(index);
                    }
                }
            });
        });
    </script>
</body>
</html>
